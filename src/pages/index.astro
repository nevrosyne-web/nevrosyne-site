---
import BaseLayout from "../layouts/BaseLayout.astro";
import YouTube from "../components/YouTube.astro";
import ClientsGrid from "../components/ClientsGrid.astro";
import clients from "../content/clients.json";
import showsData from "../content/concerts.json";
import photos from "../content/gallery.json";
import { withBase } from "../utils/paths.ts";

// Prochaine(s) date(s)
const today = new Date().toISOString().slice(0,10);
const nextShows = (Array.isArray(showsData) ? showsData : [])
  .filter(s => s.date >= today)
  .sort((a,b) => a.date.localeCompare(b.date))
  .slice(0, 3);

// Normalise les chemins d’images de la galerie avec la base
const galleryStrip = (Array.isArray(photos) ? photos : []).map((p) => ({
  src: withBase(String(p.src || "").replace(/^\//, "")),
  alt: p.alt || "Nevrosyne - galerie",
}));

// Helper lien “Infos” (si s.link est externe on garde tel quel)
const hrefInfos = (s) => {
  if (s?.link && /^(https?:)?\/\//i.test(s.link)) return s.link;
  return withBase(String(s?.link || "concerts").replace(/^\//, ""));
};
---
<BaseLayout title="Nevrosyne 5ch — Rock approximatif • Marseille">
  <!-- HERO -->
  <section class="grid md:grid-cols-2 gap-10 items-center">
    <div class="space-y-6">
      <p class="text-sm tracking-widest uppercase opacity-70">Rock approximatif • Marseille - PACA</p>
      <h1 class="font-display text-6xl md:text-7xl leading-none">
        NEVROSYNE 5CH
      </h1>
      <p class="text-lg opacity-85">
        Le seul et l'unique groupe officiel de rock approximatif de l'univers !
      </p>
      <p class="text-lg opacity-85">
        Toute l'énergie du live au travers de reprises et adaptations musicales pour lutter contre la sinistrose ! Découvre les clips, les dates et suis nous sur les réseaux.
      </p>

      <div class="flex flex-wrap gap-3">
        <a href={withBase("concerts")} class="px-5 py-3 rounded-xl bg-coal-800 hover:bg-coal-700 border border-zinc-700">
          Prochains concerts
        </a>
        <a href={withBase("media")} class="px-5 py-3 rounded-xl border border-zinc-700 hover:border-acid-400">
          Voir les médias
        </a>
        <a href={withBase("galerie")} class="px-5 py-3 rounded-xl border border-zinc-700 hover:border-acid-400/80">
          Galerie
        </a>
      </div>

      <!-- Mini bar infos -->
      {nextShows.length > 0 && (
        <div class="mt-2 text-sm rounded-lg border border-zinc-800 bg-coal-800/50 p-3">
          <span class="opacity-70 mr-2">Prochaine date :</span>
          <strong>{nextShows[0].date}</strong>
          <span class="opacity-80"> — {nextShows[0].city} • {nextShows[0].venue}</span>
          <a href={withBase("concerts")} class="ml-3 underline underline-offset-4">Tout voir</a>
        </div>
      )}
    </div>

    <!-- Clip en vedette -->
    <div class="relative">
      <YouTube id="YE6cIhBlYJU" title="Clip officiel" />
      <div class="pointer-events-none absolute inset-0 ring-1 ring-acid-400/15 rounded-xl"></div>
    </div>
  </section>

  <!-- GALERIE — bande scrollable (souris / doigt) -->
  {galleryStrip.length > 0 && (
    <section class="mt-14">
      <div id="gallery-scroll" class="gallery-scroll">
        {galleryStrip.map((p, i) => (
          <a
            href={withBase("galerie")}
            key={i}
            class="gallery-item group relative block flex-shrink-0 rounded-xl overflow-hidden border border-zinc-800"
          >
            <img
              src={p.src}
              alt={p.alt}
              loading="lazy"
              class="w-full h-full object-cover transition-transform group-hover:scale-[1.05]"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- PROCHAINES DATES (3) -->
  <section class="mt-14">
    <div class="flex items-end justify-between mb-4">
      <h2 class="text-2xl font-bold">Prochains concerts</h2>
      <a href={withBase("concerts")} class="text-sm opacity-80 hover:opacity-100 underline underline-offset-4">Toutes les dates</a>
    </div>

    {nextShows.length === 0 ? (
      <p class="opacity-80">
        Aucune date annoncée pour le moment.
        <a class="underline underline-offset-4" href={withBase("newsletter")}>Abonne-toi</a> pour être prévenu·e.
      </p>
    ) : (
      <ul class="grid md:grid-cols-3 gap-4">
        {nextShows.map((s) => (
          <li class="p-4 rounded-xl bg-coal-800/60 border border-zinc-800 flex flex-col gap-2">
            <div class="text-sm opacity-70">#concert</div>
            <div class="text-lg font-semibold">{s.date}</div>
            <div class="opacity-85">{s.city} — {s.venue}</div>
            <div class="mt-auto">
              <a href={hrefInfos(s)} class="inline-block mt-3 px-4 py-2 rounded-lg bg-ink-900 hover:bg-coal-700 border border-zinc-700">
                Infos
              </a>
            </div>
          </li>
        ))}
      </ul>
    )}
  </section>

  <!-- ILS NOUS ONT FAIT CONFIANCE -->
  {Array.isArray(clients) && clients.length > 0 && (
    <section class="mt-16">
      <h2 class="text-2xl font-bold mb-4">Ils nous ont fait confiance</h2>
      <ClientsGrid items={clients} />
    </section>
  )}

  <!-- CONTACT TEASER -->
  <section class="mt-12 text-center">
    <p class="opacity-85 mb-4">Programmation, événement, presse ?</p>
    <a href={withBase("prestations")} class="inline-block px-5 py-3 rounded-xl border border-zinc-700 hover:border-acid-400">
      Voir nos prestations
    </a>
    <span class="opacity-60 mx-2">ou</span>
    <a href={withBase("contact")} class="inline-block px-5 py-3 rounded-xl bg-coal-800 hover:bg-coal-700 border border-zinc-700">
      Nous écrire
    </a>
  </section>

  <!-- Script d’auto-scroll pour la galerie (version Safari-safe) -->
  <script is:raw>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("gallery-scroll");
      if (!el) return;

      const IDLE_MS = 2000;
      const STEP_PX = 1.5;
      const TICK_MS = 16;
      const RESUME_MS = 900;
      const RESPECT_REDUCED = false;

      const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      let auto = null;
      let idle = null;
      let lastUser = 0;

      const canScroll = () => el.scrollWidth > el.clientWidth;
      const startAuto = () => {
        if (auto || !canScroll()) return;
        if (RESPECT_REDUCED && reduced) return;
        el.classList.add("is-auto");
        auto = setInterval(() => {
          const max = el.scrollWidth - el.clientWidth;
          if (max <= 0) return;
          if (el.scrollLeft >= max - STEP_PX) { el.scrollLeft = 0; return; }
          el.scrollLeft += STEP_PX;
        }, TICK_MS);
      };
      const stopAuto = () => { if (auto) { clearInterval(auto); auto = null; } el.classList.remove("is-auto"); };
      const scheduleAuto = () => { if (idle) clearTimeout(idle); idle = setTimeout(startAuto, IDLE_MS); };
      const userInteracted = () => {
        lastUser = Date.now();
        stopAuto();
        if (idle) clearTimeout(idle);
        idle = setTimeout(() => { if (Date.now() - lastUser >= RESUME_MS) startAuto(); }, IDLE_MS);
      };

      el.addEventListener("wheel", (e) => {
        if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) { e.preventDefault(); el.scrollLeft += e.deltaY; }
        userInteracted();
      }, { passive: false });
      ["touchstart","touchmove","pointerdown","pointermove","keydown"].forEach(evt => {
        el.addEventListener(evt, userInteracted, { passive: true });
      });
      document.addEventListener("visibilitychange", () => { if (document.hidden) { stopAuto(); } else { scheduleAuto(); } });
      scheduleAuto();
    });
  </script>
</BaseLayout>