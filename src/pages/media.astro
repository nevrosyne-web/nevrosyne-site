---
import BaseLayout from "../layouts/BaseLayout.astro";
import YouTube from "../components/YouTube.astro";
import Bandcamp from "../components/Bandcamp.astro";
import media from "../content/media.json";
import { withBase } from "../utils/paths";

// sécurité minimale
const audios = Array.isArray(media.audios) ? media.audios : [];
const lives  = Array.isArray(media.lives)  ? media.lives  : [];
const compos  = Array.isArray(media.compos)  ? media.compos  : [];
const repets = Array.isArray(media.repets) ? media.repets : [];

// Normalise les chemins pour les fichiers locaux (mp4/jpg dans /public)
function normalize(list) {
  return list.map((v) => {
    if (v?.provider === "file" || v?.provider === "local") {
      const raw = String(v.src || "").trim();
      const src = withBase(raw.replace(/^\//, ""));
      const poster = v.poster ? withBase(String(v.poster).replace(/^\//, "")) : undefined;
      return { ...v, src, poster };
    }
    return v; // youtube, vimeo, etc.
  });
}

// (Optionnel) audios si un jour tu ajoutes des fichiers audio locaux
const normAudios = audios.map((a) => {
  if (a?.provider === "file" || a?.provider === "local") {
    const raw = String(a.src || "").trim();
    return { ...a, src: withBase(raw.replace(/^\//, "")) };
  }
  return a; // bandcamp, etc.
});

const normLives  = normalize(lives);
const normCompo  = normalize(compos);
const normRepets = normalize(repets);
---
<BaseLayout title="Médias — Nevrosyne">
  <h1 class="text-3xl font-bold mb-6">Médias</h1>

  <!--
  {normAudios.length > 0 && (
    <section class="space-y-4 mb-10">
      <h2 class="text-xl font-semibold">Écouter</h2>
      <div class="grid md:grid-cols-2 gap-6">
        {normAudios.map((a) => (
          a.provider === "bandcamp"
            ? <Bandcamp embedUrl={a.embedUrl} title={a.title} />
            : a.provider === "file" || a.provider === "local"
              ? (
                <audio controls preload="metadata" class="w-full rounded-xl border border-zinc-800">
                  <source src={a.src} type={a.mime || "audio/mpeg"} />
                  Votre navigateur ne supporte pas l’audio.
                </audio>
              )
              : null
        ))}
      </div>
    </section>
  )}
  -->

  <!-- ===== LIVES ===== -->
  {normLives.length > 0 && (
    <section class="space-y-4 mb-12" id="lives">
      <h2 class="text-xl font-semibold">Nevro Lives</h2>
      <div class="grid md:grid-cols-2 gap-6">
        {normLives.map((v) => (
          v.provider === "youtube"
            ? <YouTube id={v.id} title={v.title} />
            : (v.provider === "file" || v.provider === "local")
              ? (
                <video
                  controls
                  preload="metadata"
                  poster={v.poster}
                  class="w-full rounded-xl border border-zinc-800"
                >
                  <source src={v.src} type={v.mime || "video/mp4"} />
                  Votre navigateur ne supporte pas la vidéo.
                </video>
              )
              : null
        ))}
      </div>
    </section>
  )}

  <!-- ===== COMPOS ===== -->
  {normCompo.length > 0 && (
    <section class="space-y-4 mb-12" id="clips">
      <h2 class="text-xl font-semibold">Nevro compos</h2>
      <div class="grid md:grid-cols-2 gap-6">
        {normCompo.map((v) => (
          v.provider === "youtube"
            ? <YouTube id={v.id} title={v.title} />
            : (v.provider === "file" || v.provider === "local")
              ? (
                <video
                  controls
                  preload="metadata"
                  poster={v.poster}
                  class="w-full rounded-xl border border-zinc-800"
                >
                  <source src={v.src} type={v.mime || "video/mp4"} />
                  Votre navigateur ne supporte pas la vidéo.
                </video>
              )
              : null
        ))}
      </div>
    </section>
  )}

  <!-- ===== REPETS ===== -->
  {normRepets.length > 0 && (
    <section class="space-y-4" id="repets">
      <h2 class="text-xl font-semibold">Nevro Répéts</h2>
      <div class="grid md:grid-cols-2 gap-6">
        {normRepets.map((v) => (
          v.provider === "youtube"
            ? <YouTube id={v.id} title={v.title} />
            : (v.provider === "file" || v.provider === "local")
              ? (
                <video
                  controls
                  preload="metadata"
                  poster={v.poster}
                  class="w-full rounded-xl border border-zinc-800"
                >
                  <source src={v.src} type={v.mime || "video/mp4"} />
                  Votre navigateur ne supporte pas la vidéo.
                </video>
              )
              : null
        ))}
      </div>
    </section>
  )}
</BaseLayout>