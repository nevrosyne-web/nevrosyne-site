---
import BaseLayout from "../layouts/BaseLayout.astro";
import showsData from "../content/concerts.json";

// util: sécurise une chaîne (espaces/() etc.)
const enc = (s) => typeof s === "string" ? encodeURI(s) : s;

const today = new Date().toISOString().slice(0,10);
const fallbackPoster = "/affiches/default.png";

// normalise les champs utiles
const allShows = (Array.isArray(showsData) ? showsData : []).map((s) => {
  const poster = s.poster && String(s.poster).trim().length ? enc(s.poster) : "";
  return {
    date: s.date,
    city: s.city,
    venue: s.venue,
    link: s.link || "",
    ticketUrl: s.ticketUrl || "",
    poster,
    posterAlt: s.posterAlt || `${s.city} — ${s.venue} (${s.date})`,
  };
});

// à venir: tri croissant
const upcoming = allShows
  .filter((s) => s.date >= today)
  .sort((a, b) => a.date.localeCompare(b.date));

// passés: tri décroissant
const past = allShows
  .filter((s) => s.date < today)
  .sort((a, b) => b.date.localeCompare(a.date));

// groupement par année pour les passés
const pastByYear = past.reduce((acc, s) => {
  const y = s.date?.slice(0, 4) || "Inconnu";
  (acc[y] ||= []).push(s);
  return acc;
}, {});
const pastYears = Object.keys(pastByYear).sort((a, b) => b.localeCompare(a)); // plus récent d’abord
---
<BaseLayout title="Concerts — Nevrosyne">
  <h1 class="text-3xl font-bold mb-6">Prochains concerts</h1>

  {upcoming.length === 0 ? (
    <p class="opacity-80">
      Aucune date annoncée pour le moment. Abonne-toi à la
      <a class="underline underline-offset-4" href="/newsletter">newsletter</a>.
    </p>
  ) : (
    <ul class="space-y-4 mb-12">
      {upcoming.map((s) => {
        const hasPoster = !!s.poster;
        const posterSrc = hasPoster ? s.poster : fallbackPoster;
        return (
          <li class="p-4 rounded-xl bg-coal-800/60 border border-zinc-800 flex gap-4">
            <div class="w-32 md:w-40 flex-shrink-0 rounded-lg overflow-hidden border border-zinc-800 bg-black/40">
              <img
                src={(s.poster && enc(s.poster)) || fallbackPoster}
                alt={s.posterAlt}
                loading="lazy"
                decoding="async"
                width="320" height="450"
                class="w-full h-full object-cover"
              />
            </div>

            <div class="flex-1 min-w-0">
              <div class="text-sm opacity-70">#concert</div>
              <div class="text-lg font-semibold">{s.date}</div>
              <div class="opacity-85">{s.city} — {s.venue}</div>

              <div class="mt-3 flex flex-wrap gap-2">
                {s.link && (
                  <a href={s.link}
                     class="px-4 py-2 rounded-lg bg-ink-900 hover:bg-coal-700 border border-zinc-700">
                    Infos
                  </a>
                )}
                {s.ticketUrl && (
                  <a href={s.ticketUrl}
                     class="px-4 py-2 rounded-lg border border-acid-400/60 hover:border-acid-400">
                    Billetterie
                  </a>
                )}
              </div>
            </div>
          </li>
        );
      })}
    </ul>
  )}

  <!-- Séparateur -->
  <div class="border-t border-zinc-800 my-8"></div>

  <h2 class="text-2xl font-bold mb-4">Tu as raté ...</h2>

  {past.length === 0 ? (
    <p class="opacity-80">L’historique sera bientôt disponible.</p>
  ) : (
    <section class="space-y-6">
      {
        pastYears.map((year, idx) => (
          <details class="rounded-xl border border-zinc-800 bg-coal-800/40" open={idx === 0}>
            <summary class="cursor-pointer select-none px-4 py-3 flex items-center justify-between">
              <span class="font-semibold">{year}</span>
              <span class="text-sm opacity-70">{pastByYear[year].length} date{pastByYear[year].length > 1 ? 's' : ''}</span>
            </summary>
            <ul class="px-4 pb-4 space-y-4">
              {
                pastByYear[year].map((s) => {
                  const hasPoster = !!s.poster;
                  const posterSrc = hasPoster ? s.poster : fallbackPoster;
                  return (
                    <li class="p-4 rounded-xl bg-coal-800/60 border border-zinc-800 flex gap-4">
                      <div class="w-24 md:w-32 flex-shrink-0 rounded-lg overflow-hidden border border-zinc-800 bg-black/40">
                        <img
                          src={(s.poster && enc(s.poster)) || fallbackPoster}
                          alt={s.posterAlt}
                          loading="lazy"
                          decoding="async"
                          width="256" height="360"
                          class="w-full h-full object-cover"
                        />
                      </div>

                      <div class="flex-1 min-w-0">
                        <div class="text-sm opacity-70">#concert</div>
                        <div class="font-semibold">{s.date}</div>
                        <div class="opacity-85">{s.city} — {s.venue}</div>

                        <div class="mt-3 flex flex-wrap gap-2">
                          {s.link && (
                            <a href={s.link}
                               class="px-3 py-2 rounded-lg bg-ink-900 hover:bg-coal-700 border border-zinc-700 text-sm">
                              Infos
                            </a>
                          )}
                        </div>
                      </div>
                    </li>
                  );
                })
              }
            </ul>
          </details>
        ))
      }
    </section>
  )}

  <dialog id="poster-lightbox" class="backdrop:bg-black/80 rounded-xl p-0 border-0">
    <img id="poster-lightbox-img" src="" alt="" class="max-h-[85vh] max-w-[90vw] object-contain" />
  </dialog>

  <script is:raw>
    document.addEventListener("DOMContentLoaded", () => {
      const dlg = document.getElementById("poster-lightbox");
      const img = document.getElementById("poster-lightbox-img");
      document.querySelectorAll('img[alt*="Nevrosyne"], img[alt*="—"]').forEach(el => {
        el.style.cursor = "zoom-in";
        el.addEventListener("click", () => {
          img.src = el.src;
          img.alt = el.alt || "Affiche de concert";
          dlg.showModal?.();
        });
      });
      dlg.addEventListener("click", (e) => { if (e.target === dlg) dlg.close(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape" && dlg.open) dlg.close(); });
    });
  </script>

</BaseLayout>